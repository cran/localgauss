<title>Generated by TAPENADE</title>
<link type="text/CSS" rel="stylesheet" href="tapenade.css">
<link type="text/CSS" rel="stylesheet" href="fortranStyle.css">
<body>
<pre><code class="comment">!        Generated by TAPENADE     (INRIA, Tropics team)</code>
<a name="lgobfun"></a><code class="comment">!  Tapenade 3.2 (r3024) - 06/17/2009 13:03</code>
<code class="comment">!  </code>
<a href="obfun_dv.html#lgobfun_dv" target="diffFile"><code class="comment">! This is the objective function</code></a>
<a name="lgobfuni0"></a><a href="obfun_dv.html#lgobfun_dv" target="diffFile"><code class="keyword">SUBROUTINE </code><code class="funcname">LGOBFUN</code>(<code class="vardecl">n</code>, <code class="vardecl">x</code>, <code class="vardecl">y</code>, <code class="vardecl">wts</code>, <code class="vardecl">x0</code>, <code class="vardecl">y0</code>, <code class="vardecl">pp</code>, <code class="vardecl">hx</code>, <code class="vardecl">hy</code>, <code class="vardecl">ll</code>, <code class="vardecl">cv</code>, <code class="vardecl">fixrho</code>)</a>
  <a href="obfun_dv.html#lgobfun_dv" target="diffFile"><code class="keyword">IMPLICIT NONE</code></a>
<a name="lgobfuni1"></a><a href="obfun_dv.html#lgobfun_dvi0" target="diffFile"><code class="comment">! number of data points</code></a>
  <a href="obfun_dv.html#lgobfun_dvi0" target="diffFile"><code class="typename">INTEGER, INTENT(IN) </code>:: <code class="vardecl">n</code></a>
<a name="lgobfuni2"></a><a href="obfun_dv.html#lgobfun_dvi1" target="diffFile"><code class="comment">! x-data points</code></a>
  <a href="obfun_dv.html#lgobfun_dvi1" target="diffFile"><code class="typename">REAL*8, DIMENSION(n), INTENT(IN) </code>:: <code class="vardecl">x</code></a>
<a name="lgobfuni3"></a><a href="obfun_dv.html#lgobfun_dvi2" target="diffFile"><code class="comment">! y-data points</code></a>
  <a href="obfun_dv.html#lgobfun_dvi2" target="diffFile"><code class="typename">REAL*8, DIMENSION(n), INTENT(IN) </code>:: <code class="vardecl">y</code></a>
<a name="lgobfuni4"></a><a href="obfun_dv.html#lgobfun_dvi3" target="diffFile"><code class="comment">! kernel weights of each data point</code></a>
  <a href="obfun_dv.html#lgobfun_dvi3" target="diffFile"><code class="typename">REAL*8, DIMENSION(n), INTENT(IN) </code>:: <code class="vardecl">wts</code></a>
<a name="lgobfuni5"></a><a href="obfun_dv.html#lgobfun_dvi4" target="diffFile"><code class="comment">! x-coordinate where local parameters are computed</code></a>
  <a href="obfun_dv.html#lgobfun_dvi4" target="diffFile"><code class="typename">REAL*8, INTENT(IN) </code>:: <code class="vardecl">x0</code></a>
<a name="lgobfuni6"></a><a href="obfun_dv.html#lgobfun_dvi5" target="diffFile"><code class="comment">! y-coordinate where local parameters are computed</code></a>
  <a href="obfun_dv.html#lgobfun_dvi5" target="diffFile"><code class="typename">REAL*8, INTENT(IN) </code>:: <code class="vardecl">y0</code></a>
<a name="lgobfuni7"></a><a href="obfun_dv.html#lgobfun_dvi6" target="diffFile"><code class="comment">! transformed parameters used by optimizer</code></a>
  <a href="obfun_dv.html#lgobfun_dvi6" target="diffFile"><code class="typename">REAL*8, DIMENSION(5), INTENT(IN) </code>:: <code class="vardecl">pp</code></a>
<a name="lgobfuni8"></a><a href="obfun_dv.html#lgobfun_dvi7" target="diffFile"><code class="comment">! x-dir bandwidth</code></a>
  <a href="obfun_dv.html#lgobfun_dvi7" target="diffFile"><code class="typename">REAL*8, INTENT(IN) </code>:: <code class="vardecl">hx</code></a>
<a name="lgobfuni9"></a><a href="obfun_dv.html#lgobfun_dvi8" target="diffFile"><code class="comment">! y-dir bandwidth</code></a>
  <a href="obfun_dv.html#lgobfun_dvi8" target="diffFile"><code class="typename">REAL*8, INTENT(IN) </code>:: <code class="vardecl">hy</code></a>
<a name="lgobfuni10"></a><a href="obfun_dv.html#lgobfun_dvi9" target="diffFile"><code class="comment">! should the input parameters be transformed?</code></a>
  <a href="obfun_dv.html#lgobfun_dvi9" target="diffFile"><code class="typename">LOGICAL, INTENT(IN) </code>:: <code class="vardecl">cv</code></a>
<a name="lgobfuni11"></a><a href="obfun_dv.html#lgobfun_dvi10" target="diffFile"><code class="comment">! fixed rho?</code></a>
  <a href="obfun_dv.html#lgobfun_dvi10" target="diffFile"><code class="typename">REAL*8, INTENT(IN) </code>:: <code class="vardecl">fixrho</code></a>
<a name="lgobfuni12"></a><a href="obfun_dv.html#lgobfun_dvi11" target="diffFile"><code class="comment">! objective function out</code></a>
<a name="lgobfuni13"></a>  <a href="obfun_dv.html#lgobfun_dvi11" target="diffFile"><code class="typename">REAL*8, INTENT(OUT) </code>:: <code class="vardecl">ll</code></a>
<a name="lgobfuni14"></a>  <a href="obfun_dv.html#lgobfun_dvi12" target="diffFile"><code class="typename">REAL*8, DIMENSION(n) </code>:: <code class="vardecl">lgauss</code></a>
<a name="lgobfuni15"></a>  <a href="obfun_dv.html#lgobfun_dvi13" target="diffFile"><code class="typename">REAL*8, DIMENSION(5) </code>:: <code class="vardecl">pars2</code></a>
<a name="lgobfuni16"></a>  <a href="obfun_dv.html#lgobfun_dvi14" target="diffFile"><code class="typename">REAL*8, DIMENSION(1) </code>:: <code class="vardecl">xtmp</code>, <code class="vardecl">ytmp</code>, <code class="vardecl">restmp</code></a>
<a name="lgobfuni17"></a>  <a href="obfun_dv.html#lgobfun_dvi15" target="diffFile"><code class="typename">REAL*8, DIMENSION(5) </code>:: <code class="vardecl">pars</code></a>
  <a href="obfun_dv.html#lgobfun_dvi16" target="diffFile"><code class="typename">REAL*8</code>, DIMENSION(n) :: <code class="vardecl">arg1</code></a>
  <a href="obfun_dv.html#lgobfun_dvi17" target="diffFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">arg10</code></a>
  <a href="obfun_dv.html#lgobfun_dv" target="diffFile"><code class="keyword">INTRINSIC </code><code class="funcname">EXP</code></a>
  <a href="obfun_dv.html#lgobfun_dv" target="diffFile"><code class="keyword">INTRINSIC </code><code class="funcname">ABS</code></a>
  <a href="obfun_dv.html#lgobfun_dv" target="diffFile"><code class="keyword">INTRINSIC </code><code class="funcname">SUM</code></a>
  <a href="obfun_dv.html#lgobfun_dv" target="diffFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">abs2</code></a>
<a name="lgobfuni18"></a>  <a href="obfun_dv.html#lgobfun_dv" target="diffFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">abs1</code></a>
<a name="lgobfuni19"></a>  <a href="obfun_dv.html#lgobfun_dv" target="diffFile"><code class="keyword">INTRINSIC </code><code class="funcname">SQRT</code></a>
  <a href="obfun_dv.html#lgobfun_dvi18" target="diffFile">ll = <code class="constant">0.0_8</code></a>
<a name="lgobfuni20"></a><a href="obfun_dv.html#lgobfun_dvi19" target="diffFile"><code class="comment">! if cv=TRUE; Transform parameters</code></a>
<a name="lgobfuni21"></a>  <a href="obfun_dv.html#lgobfun_dvi19" target="diffFile"><code class="keyword">IF</code> (cv) <code class="keyword">THEN</code></a>
<a name="lgobfuni22"></a>    <a href="obfun_dv.html#lgobfun_dvi20" target="diffFile">pars(<code class="constant">1</code>:<code class="constant">2</code>) = pp(<code class="constant">1</code>:<code class="constant">2</code>)</a>
<a name="lgobfuni24"></a>    <a href="obfun_dv.html#lgobfun_dvi21" target="diffFile">pars(<code class="constant">3</code>:<code class="constant">4</code>) = <code class="funcname">EXP</code>(pp(<code class="constant">3</code>:<code class="constant">4</code>))</a>
    <a href="obfun_dv.html#lgobfun_dvi22" target="diffFile"><code class="keyword">IF</code> (fixrho .GE. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
<a name="lgobfuni23"></a>      <a href="obfun_dv.html#lgobfun_dvi24" target="diffFile">abs1 = fixrho</a>
    <a href="obfun_dv.html#lgobfun_dvi22" target="diffFile"><code class="keyword">ELSE</code></a>
<a name="lgobfuni25"></a>      <a href="obfun_dv.html#lgobfun_dvi23" target="diffFile">abs1 = -fixrho</a>
<a name="lgobfuni27"></a>    <a href="obfun_dv.html#lgobfun_dvi22" target="diffFile"><code class="keyword">END IF</code></a>
<a name="lgobfuni28"></a>    <a href="obfun_dv.html#lgobfun_dvi25" target="diffFile"><code class="keyword">IF</code> (abs1 .LT. <code class="constant">1.0_8</code>) <code class="keyword">THEN</code></a>
      <a href="obfun_dv.html#lgobfun_dvi27" target="diffFile">pars(<code class="constant">5</code>) = fixrho</a>
<a href="obfun_dv.html#lgobfun_dvi28" target="diffFile"><code class="comment">! add this to make optimizer work</code></a>
<a href="obfun_dv.html#lgobfun_dvi28" target="diffFile"><code class="comment">! if rho is fixed</code></a>
<a name="lgobfuni26"></a>      <a href="obfun_dv.html#lgobfun_dvi28" target="diffFile">ll = -(<code class="constant">0.5_8</code>*pp(<code class="constant">5</code>)**<code class="constant">2</code>)</a>
    <a href="obfun_dv.html#lgobfun_dvi25" target="diffFile"><code class="keyword">ELSE</code></a>
      <a href="obfun_dv.html#lgobfun_dvi26" target="diffFile">pars(<code class="constant">5</code>) = -<code class="constant">1.0_8 </code>+ <code class="constant">2.0_8</code>*<code class="funcname">EXP</code>(pp(<code class="constant">5</code>))/(<code class="constant">1.0_8</code>+<code class="funcname">EXP</code>(pp(<code class="constant">5</code>)))</a>
<a name="lgobfuni29"></a>    <a href="obfun_dv.html#lgobfun_dvi25" target="diffFile"><code class="keyword">END IF</code></a>
  <a href="obfun_dv.html#lgobfun_dvi19" target="diffFile"><code class="keyword">ELSE</code></a>
<a name="lgobfuni30"></a><a href="obfun_dv.html#lgobfun_dvi29" target="diffFile"><code class="comment">! otherwise, pass parameters as they are</code></a>
<a name="lgobfuni32"></a>    <a href="obfun_dv.html#lgobfun_dvi29" target="diffFile">pars = pp</a>
    <a href="obfun_dv.html#lgobfun_dvi30" target="diffFile"><code class="keyword">IF</code> (fixrho .GE. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
<a name="lgobfuni31"></a>      <a href="obfun_dv.html#lgobfun_dvi32" target="diffFile">abs2 = fixrho</a>
    <a href="obfun_dv.html#lgobfun_dvi30" target="diffFile"><code class="keyword">ELSE</code></a>
<a name="lgobfuni34"></a><a name="lgobfuni33"></a>      <a href="obfun_dv.html#lgobfun_dvi31" target="diffFile">abs2 = -fixrho</a>
    <a href="obfun_dv.html#lgobfun_dvi30" target="diffFile"><code class="keyword">END IF</code></a>
<a name="lgobfuni35"></a>    <a href="obfun_dv.html#lgobfun_dvi33" target="diffFile"><code class="keyword">IF</code> (abs2 .LT. <code class="constant">1.0_8</code>) </a><a href="obfun_dv.html#lgobfun_dvi34" target="diffFile">pars(<code class="constant">5</code>) = fixrho</a>
  <a href="obfun_dv.html#lgobfun_dvi19" target="diffFile"><code class="keyword">END IF</code></a>
<a name="lgobfuni36"></a><a href="obfun_dv.html#lgobfun_dvi35" target="diffFile"><code class="comment">! compute logdensites for the weighted log-likelihood</code></a>
  <a href="obfun_dv.html#lgobfun_dvi35" target="diffFile"><code class="keyword">CALL </code><code class="funcname">LOGGAUSSPDF</code>(n, x, y, pars, lgauss)</a>
<a name="lgobfuni37"></a><a href="obfun_dv.html#lgobfun_dvi36" target="diffFile"><code class="comment">! weighted log-likelihood</code></a>
<a name="lgobfuni38"></a>  <a href="obfun_dv.html#lgobfun_dvi36" target="diffFile">arg1(:) = wts*lgauss</a>
  <a href="obfun_dv.html#lgobfun_dvi37" target="diffFile">ll = ll + <code class="funcname">SUM</code>(arg1(:))/(<code class="constant">1.0_8</code>*n)</a>
<a name="lgobfuni39"></a><a href="obfun_dv.html#lgobfun_dvi38" target="diffFile"><code class="comment">! work out parameters for the penalty term</code></a>
<a name="lgobfuni40"></a>  <a href="obfun_dv.html#lgobfun_dvi38" target="diffFile">pars2(<code class="constant">1</code>:<code class="constant">2</code>) = pars(<code class="constant">1</code>:<code class="constant">2</code>)</a>
<a name="lgobfuni41"></a>  <a href="obfun_dv.html#lgobfun_dvi39" target="diffFile">arg10 = pars(<code class="constant">3</code>)**<code class="constant">2 </code>+ hx**<code class="constant">2</code></a>
<a name="lgobfuni42"></a>  <a href="obfun_dv.html#lgobfun_dvi40" target="diffFile">pars2(<code class="constant">3</code>) = <code class="funcname">SQRT</code>(arg10)</a>
<a name="lgobfuni43"></a>  <a href="obfun_dv.html#lgobfun_dvi41" target="diffFile">arg10 = pars(<code class="constant">4</code>)**<code class="constant">2 </code>+ hy**<code class="constant">2</code></a>
<a name="lgobfuni44"></a>  <a href="obfun_dv.html#lgobfun_dvi42" target="diffFile">pars2(<code class="constant">4</code>) = <code class="funcname">SQRT</code>(arg10)</a>
<a name="lgobfuni45"></a>  <a href="obfun_dv.html#lgobfun_dvi43" target="diffFile">pars2(<code class="constant">5</code>) = pars(<code class="constant">5</code>)*pars(<code class="constant">3</code>)*pars(<code class="constant">4</code>)/(pars2(<code class="constant">3</code>)*pars2(<code class="constant">4</code>))</a>
<a name="lgobfuni46"></a>  <a href="obfun_dv.html#lgobfun_dvi44" target="diffFile">xtmp(<code class="constant">1</code>) = x0</a>
<a name="lgobfuni47"></a>  <a href="obfun_dv.html#lgobfun_dvi45" target="diffFile">ytmp(<code class="constant">1</code>) = y0</a>
  <a href="obfun_dv.html#lgobfun_dvi46" target="diffFile"><code class="keyword">CALL </code><code class="funcname">LOGGAUSSPDF</code>(<code class="constant">1</code>, xtmp, ytmp, pars2, restmp)</a>
<a href="obfun_dv.html#lgobfun_dvi47" target="diffFile"><code class="comment">! add penalty term to objective</code></a>
  <a href="obfun_dv.html#lgobfun_dvi47" target="diffFile">ll = ll - <code class="funcname">EXP</code>(restmp(<code class="constant">1</code>))</a>
<a name="loggausspdf"></a><a href="obfun_dv.html#lgobfun_dv" target="diffFile"><code class="keyword">END </code><code class="keywork">SUBROUTINE </code><code class="funcname">LGOBFUN</code></a>

<a href="obfun_dv.html#loggausspdf_dv" target="diffFile"><code class="comment">!----------------------------------------------------------------------</code></a>
<a href="obfun_dv.html#loggausspdf_dv" target="diffFile"><code class="comment">! This file defines the objective function for local gaussian correlation</code></a>
<a href="obfun_dv.html#loggausspdf_dv" target="diffFile"><code class="comment">!----------------------------------------------------------------------</code></a>
<a href="obfun_dv.html#loggausspdf_dv" target="diffFile"><code class="comment">! Throughout, we use the convetion for parameters of a bivariate gaussian</code></a>
<a href="obfun_dv.html#loggausspdf_dv" target="diffFile"><code class="comment">! pars(1) = mu_x</code></a>
<a href="obfun_dv.html#loggausspdf_dv" target="diffFile"><code class="comment">! pars(2) = mu_y</code></a>
<a href="obfun_dv.html#loggausspdf_dv" target="diffFile"><code class="comment">! pars(3) = sigma_x</code></a>
<a href="obfun_dv.html#loggausspdf_dv" target="diffFile"><code class="comment">! pars(4) = sigma_y</code></a>
<a href="obfun_dv.html#loggausspdf_dv" target="diffFile"><code class="comment">! pars(5) = rho</code></a>
<a href="obfun_dv.html#loggausspdf_dv" target="diffFile"><code class="comment">!-------------------------------------------------------------------------</code></a>
<a href="obfun_dv.html#loggausspdf_dv" target="diffFile"><code class="comment">! log-density of a bivariate Gaussian, vectorized in the data</code></a>
<a href="obfun_dv.html#loggausspdf_dv" target="diffFile"><code class="comment">! with parameters fixed</code></a>
<a name="loggausspdfi0"></a><a href="obfun_dv.html#loggausspdf_dv" target="diffFile"><code class="keyword">SUBROUTINE </code><code class="funcname">LOGGAUSSPDF</code>(<code class="vardecl">n</code>, <code class="vardecl">x</code>, <code class="vardecl">y</code>, <code class="vardecl">pars</code>, <code class="vardecl">res</code>)</a>
<a name="loggausspdfi1"></a>  <a href="obfun_dv.html#loggausspdf_dv" target="diffFile"><code class="keyword">IMPLICIT NONE</code></a>
<a name="loggausspdfi2"></a>  <a href="obfun_dv.html#loggausspdf_dvi0" target="diffFile"><code class="typename">REAL*8, PARAMETER </code>:: <code class="vardecl">twopi</code>=<code class="constant">6.283185307179586e+00_8</code></a>
<a name="loggausspdfi3"></a>  <a href="obfun_dv.html#loggausspdf_dvi1" target="diffFile"><code class="typename">INTEGER, INTENT(IN) </code>:: <code class="vardecl">n</code></a>
<a name="loggausspdfi4"></a>  <a href="obfun_dv.html#loggausspdf_dvi2" target="diffFile"><code class="typename">REAL*8, DIMENSION(n), INTENT(IN) </code>:: <code class="vardecl">x</code></a>
<a name="loggausspdfi5"></a>  <a href="obfun_dv.html#loggausspdf_dvi3" target="diffFile"><code class="typename">REAL*8, DIMENSION(n), INTENT(IN) </code>:: <code class="vardecl">y</code></a>
<a name="loggausspdfi6"></a>  <a href="obfun_dv.html#loggausspdf_dvi4" target="diffFile"><code class="typename">REAL*8, DIMENSION(5), INTENT(IN) </code>:: <code class="vardecl">pars</code></a>
<a name="loggausspdfi7"></a>  <a href="obfun_dv.html#loggausspdf_dvi5" target="diffFile"><code class="typename">REAL*8, DIMENSION(n), INTENT(OUT) </code>:: <code class="vardecl">res</code></a>
<a name="loggausspdfi8"></a>  <a href="obfun_dv.html#loggausspdf_dvi6" target="diffFile"><code class="typename">REAL*8, DIMENSION(n) </code>:: <code class="vardecl">cen1</code>, <code class="vardecl">cen2</code></a>
<a name="loggausspdfi9"></a>  <a href="obfun_dv.html#loggausspdf_dvi7" target="diffFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">t1</code>, <code class="vardecl">f1</code>, <code class="vardecl">f2</code>, <code class="vardecl">f12</code></a>
<a name="loggausspdfi10"></a>  <a href="obfun_dv.html#loggausspdf_dvi8" target="diffFile"><code class="typename">REAL(8) </code>:: <code class="vardecl">arg1</code></a>
  <a href="obfun_dv.html#loggausspdf_dvi9" target="diffFile"><code class="typename">REAL </code>:: <code class="vardecl">result1</code></a>
  <a href="obfun_dv.html#loggausspdf_dvi10" target="diffFile"><code class="typename">REAL*8 </code>:: <code class="vardecl">arg2</code></a>
<a name="loggausspdfi11"></a>  <a href="obfun_dv.html#loggausspdf_dv" target="diffFile"><code class="keyword">INTRINSIC </code><code class="funcname">LOG</code></a>
<a name="loggausspdfi12"></a>  <a href="obfun_dv.html#loggausspdf_dv" target="diffFile"><code class="keyword">INTRINSIC </code><code class="funcname">SQRT</code></a>
<a name="loggausspdfi13"></a>  <a href="obfun_dv.html#loggausspdf_dvi11" target="diffFile">t1 = -(<code class="constant">0.5_8</code>/(<code class="constant">1.0_8</code>-pars(<code class="constant">5</code>)**<code class="constant">2</code>))</a>
<a name="loggausspdfi14"></a>  <a href="obfun_dv.html#loggausspdf_dvi12" target="diffFile">f1 = t1/pars(<code class="constant">3</code>)**<code class="constant">2</code></a>
<a name="loggausspdfi15"></a>  <a href="obfun_dv.html#loggausspdf_dvi13" target="diffFile">f2 = t1/pars(<code class="constant">4</code>)**<code class="constant">2</code></a>
<a name="loggausspdfi16"></a>  <a href="obfun_dv.html#loggausspdf_dvi14" target="diffFile">f12 = -(<code class="constant">2.0</code>*pars(<code class="constant">5</code>)*t1/(pars(<code class="constant">3</code>)*pars(<code class="constant">4</code>)))</a>
<a name="loggausspdfi17"></a>  <a href="obfun_dv.html#loggausspdf_dvi15" target="diffFile">cen1 = x - pars(<code class="constant">1</code>)</a>
<a name="loggausspdfi18"></a>  <a href="obfun_dv.html#loggausspdf_dvi16" target="diffFile">cen2 = y - pars(<code class="constant">2</code>)</a>
<a name="loggausspdfi19"></a>  <a href="obfun_dv.html#loggausspdf_dvi17" target="diffFile">arg1 = <code class="constant">1.0_8 </code>- pars(<code class="constant">5</code>)**<code class="constant">2</code></a>
<a name="loggausspdfi20"></a>  <a href="obfun_dv.html#loggausspdf_dvi18" target="diffFile">result1 = <code class="funcname">SQRT</code>(arg1)</a>
  <a href="obfun_dv.html#loggausspdf_dvi19" target="diffFile">arg2 = twopi*pars(<code class="constant">3</code>)*pars(<code class="constant">4</code>)*result1</a>
  <a href="obfun_dv.html#loggausspdf_dvi20" target="diffFile">res = -<code class="funcname">LOG</code>(arg2) + f1*cen1**<code class="constant">2 </code>+ f2*cen2**<code class="constant">2 </code>+ f12*cen1*cen2</a>
<a href="obfun_dv.html#loggausspdf_dv" target="diffFile"><code class="keyword">END </code><code class="keywork">SUBROUTINE </code><code class="funcname">LOGGAUSSPDF</code></a>

</pre>
</body>
